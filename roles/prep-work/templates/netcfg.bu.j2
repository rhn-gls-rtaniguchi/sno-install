variant: openshift
version: 4.13.0
metadata:
  name: 01-master-network-{{ node.network_adapter }}
  labels:
    machineconfiguration.openshift.io/role: master
storage:
  files:
    - path: /etc/zincati/config.d/90-disable-feature.toml
      mode: 0644
      contents:
        inline: |
          [updates]
          enabled = false
    - path: /etc/systemd/network/25-{{ node.network_adapter }}.link
      mode: 0644
      contents:
        inline: |
          [Match]
          MACAddress={{ node.mac | replace('-',':') }}
          [Link]
          Name={{ node.network_adapter }}
    - path: /etc/NetworkManager/system-connections/{{ node.network_adapter }}.nmconnection
      mode: 0600
      overwrite: true
      contents:
        inline: |
          [connection]
          id={{ node.network_adapter }}
          type=ethernet
          interface-name={{ node.network_adapter }}

          [ethernet]
          mac-address={{ node.mac | replace('-',':') }}
          mtu=1500

          [ipv4]
          address1={{ node.ip }}/24,172.25.254.250
          dhcp-hostname=node
          dns=172.25.254.250;
          may-fail=false
          method=manual

    - path: /etc/hostname
      mode: 0644
      overwrite: true
      contents:
        inline: |
          {{ node.name }}.{{ node.cluster }}.example.com

    - path: /etc/chrony.conf
      mode: 0644
      overwrite: true
      contents:
        inline: |
          pool {{ node.ip }} iburst 
          driftfile /var/lib/chrony/drift
          makestep 1.0 3
          rtcsync
          logdir /var/log/chrony
#    - path: /opt/openshift/openshift/98_openshift-machineconfig_98-master-config-bip.yaml
#      mode: 0644
#      overwrite: true
#      contents:
#        source: data:text/plain;base64,{{ lookup('file','/home/kiosk/98_openshift-machineconfig_98-master-config-bip.yaml') | b64encode }}
systemd:
  units:
  - contents: |
      [Unit]
      Description=Wipe Boot Disk After BootKube Completes
      Wants=bootkube.service
      After=bootkube.service
      ConditionPathExists=/opt/openshift/.bootkube.done

      [Service]
      WorkingDirectory=/
      ExecStart=/bin/bash -c "/usr/sbin/wipefs -af {{ node.bootstrap_disk }} && /usr/sbin/reboot"

      [Install]
      WantedBy=multi-user.target
    enabled: true
    name: wipe-boot-dev.service