---
# Deploying:
#  - PXE config
#  - install-config.yaml
#  - network customization
#
# REQUIRES:
#  - variable "node" according to vms structure

    
# Create the OCP installation directory and populate it
- name: Make sure workdir exists
  become: no
  file:
    path: /home/kiosk/{{ node.cluster }}
    state: directory
    mode: 0755

# First make sure all target locations exist
- name: Create the download directories if not there yet
  become: no
  ansible.builtin.file:
    path: "/home/kiosk/tmp"
    state: directory

- name: Place the install config to workdir
  become: no
  template:
    src: templates/install-config-sno.yaml.j2
    dest: /home/kiosk/{{ node.cluster }}/install-config.yaml
    mode: 0644


- name: Create a backup copy of install config
  become: no
  copy:
    src: /home/kiosk/{{ node.cluster }}/install-config.yaml
    dest: /home/kiosk/install-config-{{ node.cluster }}.yaml
    remote_src: yes
    mode: 0644

- name: Create a copy to merge with the workarounds
  become: no
  copy:
    src: /home/kiosk/{{ node.cluster }}/install-config.yaml
    dest: /home/kiosk/tmp/install-config.yaml
    remote_src: yes
    mode: 0644


- name: Deploy the environment workarounds
  become: no
  template:
    src: templates/bootstrap.bu.j2
    dest: /home/kiosk/bootstrap.yaml
    mode: 0644

- name: Process workaround config with butane
  become: no
  shell: butane bootstrap.yaml -d /home/kiosk/tmp -o /home/kiosk/{{ node.cluster }}/install-config-{{ node.cluster }}.yaml  
  args:
    chdir: /home/kiosk


- name: Create the ignition file
  become: no
  shell: openshift-install create single-node-ignition-config
  args:
    chdir: /home/kiosk/{{ node.cluster }}

- name: Publish ignition configs
  copy:
    src: /home/kiosk/{{ node.cluster }}/bootstrap-in-place-for-live-iso.ign
    dest: "{{ ignitions_directory }}/{{ node.cluster }}-{{ node.name }}.ign"
    remote_src: yes
    mode: 0644
    owner: root
    group: root

# Create a backup copy of cluster auth files
- name: Create a backup copy of cluster auth files
  become: no
  copy:
    src: /home/kiosk/{{ node.cluster }}/auth/{{ item }}
    dest: /home/kiosk/{{ item }}-{{ node.cluster }}
    remote_src: yes
    mode: 0644
  loop:
    - kubeadmin-password
    - kubeconfig

...
